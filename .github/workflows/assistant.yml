name: üéì –£—á–µ–±–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç

on:
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  workflow_dispatch:
    inputs:
      action:
        description: '–î–µ–π—Å—Ç–≤–∏–µ'
        required: false
        default: 'schedule'
        type: choice
        options:
          - schedule
          - tasks
          - progress

  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
  schedule:
    - cron: '30 7 * * 1-5'  # –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä: –ü–Ω-–ü—Ç –≤ 7:30
    - cron: '0 8 * * *'     # –°–ø–∏—Å–æ–∫ –¥–µ–ª: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 8:00
    - cron: '0 20 * * 0'    # –û—Ç—á–µ—Ç: –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 20:00

jobs:
  send-notification:
    runs-on: ubuntu-latest

    steps:
      # 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      # 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å
      - name: üîç –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
        id: determine_action
        run: |
          # –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            CRON="${{ github.event.schedule }}"
            
            if [[ "$CRON" == "30 7 * * 1-5" ]]; then
              echo "action=schedule" >> $GITHUB_OUTPUT
              echo "–ó–∞–ø—É—Å–∫: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä"
            elif [[ "$CRON" == "0 8 * * *" ]]; then
              echo "action=tasks" >> $GITHUB_OUTPUT
              echo "–ó–∞–ø—É—Å–∫: –°–ø–∏—Å–æ–∫ –¥–µ–ª"
            elif [[ "$CRON" == "0 20 * * 0" ]]; then
              echo "action=progress" >> $GITHUB_OUTPUT
              echo "–ó–∞–ø—É—Å–∫: –û—Ç—á–µ—Ç –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ"
            fi
          
          # –ï—Å–ª–∏ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ACTION="${{ github.event.inputs.action }}"
            echo "action=$ACTION" >> $GITHUB_OUTPUT
            echo "–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫: $ACTION"
          fi

      # 3. –û–ë–†–ê–ë–û–¢–ö–ê –†–ê–°–ü–ò–°–ê–ù–ò–Ø
      - name: üìÖ –ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        id: get_schedule
        if: steps.determine_action.outputs.action == 'schedule'
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
          DAYS=("–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫" "–≤—Ç–æ—Ä–Ω–∏–∫" "—Å—Ä–µ–¥–∞" "—á–µ—Ç–≤–µ—Ä–≥" "–ø—è—Ç–Ω–∏—Ü–∞" "—Å—É–±–±–æ—Ç–∞" "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ")
          DAY_NUM=$(date +%u)
          DAY_INDEX=$((DAY_NUM - 1))
          DAY_RU=${DAYS[$DAY_INDEX]}
          
          echo "day=$DAY_RU" >> $GITHUB_OUTPUT
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
          if jq -e ".$DAY_RU" schedule.json > /dev/null 2>&1; then
            SCHEDULE=$(jq -r ".$DAY_RU[] | \"‚è∞ \\(.time) - \\(.subject) (–∞—É–¥. \\(.room))\"" schedule.json)
            echo "has_schedule=true" >> $GITHUB_OUTPUT
            echo "schedule<<EOF" >> $GITHUB_OUTPUT
            echo "$SCHEDULE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_schedule=false" >> $GITHUB_OUTPUT
          fi

      # 4. –û–ë–†–ê–ë–û–¢–ö–ê –°–ü–ò–°–ö–ê –î–ï–õ
      - name: ‚úÖ –ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á–∏
        id: get_tasks
        if: steps.determine_action.outputs.action == 'tasks'
        run: |
          # –ë–µ—Ä–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
          TASKS=$(jq -r '.–µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ[]' tasks.json 2>/dev/null || echo "–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –ø—É—Å—Ç")
          
          FORMATTED=""
          while IFS= read -r task; do
            if [ -n "$task" ]; then
              FORMATTED+="‚úÖ $task\n"
            fi
          done <<< "$TASKS"
          
          echo "tasks<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FORMATTED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 5. –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø –í TELEGRAM
      - name: üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.determine_action.outputs.action == 'schedule' && 'üìÖ *–†–ê–°–ü–ò–°–ê–ù–ò–ï –ù–ê –°–ï–ì–û–î–ù–Ø*' || '' }}
            ${{ steps.determine_action.outputs.action == 'tasks' && '‚úÖ *–°–ü–ò–°–û–ö –î–ï–õ –ù–ê –°–ï–ì–û–î–ù–Ø*' || '' }}
            ${{ steps.determine_action.outputs.action == 'progress' && 'üìä *–û–¢–ß–ï–¢ –ó–ê –ù–ï–î–ï–õ–Æ*' || '' }}
            
            ${{ steps.determine_action.outputs.action == 'schedule' && format('üìÜ –î–µ–Ω—å: {0}', steps.get_schedule.outputs.day) || '' }}
            üìÖ –î–∞—Ç–∞: $(date +"%d.%m.%Y")
            
            ${{ steps.determine_action.outputs.action == 'schedule' && steps.get_schedule.outputs.has_schedule == 'true' && 'üìö *–ü–∞—Ä—ã:*\n' || '' }}
            ${{ steps.determine_action.outputs.action == 'schedule' && steps.get_schedule.outputs.schedule || '' }}
            ${{ steps.determine_action.outputs.action == 'schedule' && steps.get_schedule.outputs.has_schedule == 'false' && 'üéâ *–°–µ–≥–æ–¥–Ω—è –ø–∞—Ä –Ω–µ—Ç!*\n\n–ú–æ–∂–Ω–æ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å –∏–ª–∏ –∑–∞–Ω—è—Ç—å—Å—è —Å–∞–º–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º!' || '' }}
            
            ${{ steps.determine_action.outputs.action == 'tasks' && 'üìù *–ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:*\n' || '' }}
            ${{ steps.determine_action.outputs.action == 'tasks' && steps.get_tasks.outputs.tasks || '' }}
            
            ${{ steps.determine_action.outputs.action == 'progress' && 'üéØ *–í–∞—à–∞ –Ω–µ–¥–µ–ª—è –±—ã–ª–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–π!*\n\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n‚è∞ –ß–∞—Å–æ–≤ —É—á—ë–±—ã: 25\n‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á: 18\nüìà –°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: 85%\n\nüí° –°–æ–≤–µ—Ç: –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ—Ä—ã–≤—ã!' || '' }}
            
            ---
            ü§ñ *MyStudyAssistantBot*
            üïê $(date +"%H:%M")
          parse_mode: markdown