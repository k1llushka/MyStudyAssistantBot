name: ğŸ“ Ğ£Ñ‡ĞµĞ±Ğ½Ñ‹Ğ¹ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚

on:
  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
  workflow_dispatch:
    inputs:
      action:
        description: 'Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ'
        required: false
        default: 'schedule'
        type: choice
        options:
          - schedule
          - tasks
          - progress

  # ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ
  schedule:
    - cron: '30 7 * * 1-5'  # Ğ Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ñ€: ĞŸĞ½-ĞŸÑ‚ Ğ² 7:30
    - cron: '0 8 * * *'     # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ´ĞµĞ»: ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾ Ğ² 8:00
    - cron: '0 20 * * 0'    # ĞÑ‚Ñ‡ĞµÑ‚: Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ Ğ² 20:00

jobs:
  send-notification:
    runs-on: ubuntu-latest

    steps:
      # 1. Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ĞºĞ¾Ğ´
      - name: ğŸ“¥ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
        uses: actions/checkout@v4

      # 2. ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ´ĞµĞ½ÑŒ Ğ½ĞµĞ´ĞµĞ»Ğ¸
      - name: ğŸ“… ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ´ĞµĞ½ÑŒ Ğ½ĞµĞ´ĞµĞ»Ğ¸
        id: get_date
        run: |
          # Ğ ÑƒÑÑĞºĞ¸Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ½ĞµĞ¹
          DAYS=("Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº" "Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¸Ğº" "ÑÑ€ĞµĞ´Ğ°" "Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³" "Ğ¿ÑÑ‚Ğ½Ğ¸Ñ†Ğ°" "ÑÑƒĞ±Ğ±Ğ¾Ñ‚Ğ°" "Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ")
          DAY_NUM=$(date +%u)
          DAY_INDEX=$((DAY_NUM - 1))
          DAY_RU=${DAYS[$DAY_INDEX]}
          
          # Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ´Ğ°Ñ‚Ğ°
          CURRENT_DATE=$(date +"%d.%m.%Y")
          CURRENT_TIME=$(date +"%H:%M")
          
          echo "day=$DAY_RU" >> $GITHUB_OUTPUT
          echo "date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "time=$CURRENT_TIME" >> $GITHUB_OUTPUT

      # 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ
      - name: ğŸ“‹ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ
        id: check_schedule
        run: |
          DAY="${{ steps.get_date.outputs.day }}"
          
          if jq -e ".$DAY" schedule.json > /dev/null 2>&1; then
            # Ğ•ÑÑ‚ÑŒ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ
            SCHEDULE=$(jq -r ".$DAY[] | \"â€¢ \\(.time) - \\(.subject) (Ğ°ÑƒĞ´. \\(.room))\"" schedule.json)
            echo "has_schedule=true" >> $GITHUB_OUTPUT
            echo "schedule<<EOF" >> $GITHUB_OUTPUT
            echo "$SCHEDULE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            # ĞĞµÑ‚ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ
            echo "has_schedule=false" >> $GITHUB_OUTPUT
          fi

      # 4. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
      - name: âœ… ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
        id: get_tasks
        run: |
          TASKS=$(jq -r '.ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğµ[]' tasks.json 2>/dev/null || echo "Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹")
          
          FORMATTED=""
          while IFS= read -r task; do
            if [ -n "$task" ]; then
              FORMATTED+="â€¢ $task\n"
            fi
          done <<< "$TASKS"
          
          echo "tasks<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FORMATTED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 5. ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ ĞºĞ°ĞºĞ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ
      - name: ğŸ” ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ñ‚Ğ¸Ğ¿ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
        id: determine_message
        run: |
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            CRON="${{ github.event.schedule }}"
            
            if [[ "$CRON" == "30 7 * * 1-5" ]]; then
              # Ğ Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ñ€
              if [[ "${{ steps.check_schedule.outputs.has_schedule }}" == "true" ]]; then
                MSG="schedule"
              else
                MSG="no_schedule"
              fi
            elif [[ "$CRON" == "0 8 * * *" ]]; then
              # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ´ĞµĞ»
              MSG="tasks"
            elif [[ "$CRON" == "0 20 * * 0" ]]; then
              # ĞÑ‚Ñ‡ĞµÑ‚
              MSG="progress"
            fi
          else
            # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
            MSG="${{ github.event.inputs.action }}"
          fi
          
          echo "message_type=$MSG" >> $GITHUB_OUTPUT

      # 6. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² Telegram
      - name: ğŸ“¨ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.determine_message.outputs.message_type == 'schedule' && 'ğŸ“… *Ğ ĞĞ¡ĞŸĞ˜Ğ¡ĞĞĞ˜Ğ• ĞĞ Ğ¡Ğ•Ğ“ĞĞ”ĞĞ¯*' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'no_schedule' && 'ğŸ‰ *Ğ¡Ğ•Ğ“ĞĞ”ĞĞ¯ ĞŸĞĞ  ĞĞ•Ğ¢!*' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'tasks' && 'âœ… *Ğ¡ĞŸĞ˜Ğ¡ĞĞš Ğ”Ğ•Ğ› ĞĞ Ğ¡Ğ•Ğ“ĞĞ”ĞĞ¯*' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'progress' && 'ğŸ“Š *ĞĞ¢Ğ§Ğ•Ğ¢ Ğ—Ğ ĞĞ•Ğ”Ğ•Ğ›Ğ®*' || '' }}
            
            ğŸ“† Ğ”ĞµĞ½ÑŒ: ${{ steps.get_date.outputs.day }}
            ğŸ“… Ğ”Ğ°Ñ‚Ğ°: ${{ steps.get_date.outputs.date }}
            
            ${{ steps.determine_message.outputs.message_type == 'schedule' && 'ğŸ“š *ĞŸĞ°Ñ€Ñ‹:*\n' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'schedule' && steps.check_schedule.outputs.schedule || '' }}
            
            ${{ steps.determine_message.outputs.message_type == 'no_schedule' && '\nğŸ¯ *ĞœĞ¾Ğ¶Ğ½Ğ¾:*\nâ€¢ ĞÑ‚Ğ´Ğ¾Ñ…Ğ½ÑƒÑ‚ÑŒ\nâ€¢ Ğ—Ğ°Ğ½ÑÑ‚ÑŒÑÑ ÑĞ°Ğ¼Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼\nâ€¢ ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»\nâ€¢ Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ´Ğ¾Ğ¼Ğ°ÑˆĞ½ĞµĞµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ\n' || '' }}
            
            ${{ steps.determine_message.outputs.message_type == 'tasks' && 'ğŸ“ *Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ:*\n' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'tasks' && steps.get_tasks.outputs.tasks || '' }}
            
            ${{ steps.determine_message.outputs.message_type == 'progress' && '\nğŸ¯ *Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ·Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ:*\nâ° Ğ§Ğ°ÑĞ¾Ğ² ÑƒÑ‡Ñ‘Ğ±Ñ‹: 24\nâœ… Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡: 15\nğŸ“ˆ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ: 78%\n\nğŸ’ª *ĞœĞ¾Ğ»Ğ¾Ğ´ĞµÑ†! ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ğ¹ Ğ² Ñ‚Ğ¾Ğ¼ Ğ¶Ğµ Ğ´ÑƒÑ…Ğµ!*\n' || '' }}
            
            ---
            ğŸ¤– *MyStudyAssistantBot*
            ğŸ• ${{ steps.get_date.outputs.time }}
          parse_mode: markdown